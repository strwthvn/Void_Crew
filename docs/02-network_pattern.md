# Сетевая архитектура: тонкий клиент для космического симулятора

## Суть подхода «тонкий клиент»

### Разделение ответственности

**Сервер — это и есть игра.** Весь игровой мир существует только на сервере. Там живут все персонажи, NPC, транспорт, предметы. Там происходят все расчёты: передвижение, урон, столкновения, AI, квесты, инвентарь. Сервер хранит «правду» о состоянии мира и является единственным источником истины.

**Клиент — это окно в игру.** Он подключается к серверу и получает поток данных о том, что происходит в мире. Его единственные задачи: показать игроку картинку, воспроизвести звуки, принять ввод с клавиатуры/мыши и отправить его на сервер. Клиент не принимает никаких игровых решений.

### Как это работает

Сервер работает в цикле, например 30 раз в секунду. Каждый тик он обрабатывает ввод от всех подключённых игроков, обновляет состояние мира, просчитывает AI, физику, эффекты. После этого формирует «снимок» видимой части мира для каждого игрока и отправляет его.

Клиент получает эти снимки и отрисовывает их. Поскольку снимки приходят дискретно, клиент интерполирует между ними, чтобы движение выглядело плавно. Когда игрок нажимает кнопку — клиент не перемещает персонажа сам, а просто отправляет на сервер сообщение «игрок нажал вперёд». Сервер решает, может ли персонаж двигаться, и если да — в следующем снимке клиент увидит новую позицию.

### Почему так делают

**Защита от читов.** Если вся логика на сервере, клиент не может «сказать» серверу, что у него 1000 HP или что он телепортировался. Клиент может только отправлять ввод, а сервер сам решает, что с этим вводом делать.

**Консистентность.** Все игроки видят одну и ту же картину мира, потому что она одна — на сервере. Нет рассинхронизаций, когда у одного игрока враг мёртв, а у другого ещё жив.

**Простота клиента.** Клиент становится намного проще. Ему не нужно знать правила игры, формулы урона, логику AI. Он просто показывает то, что ему прислали.

### Цена подхода

**Задержка ввода.** Между нажатием кнопки и реакцией на экране проходит время: пакет идёт на сервер, сервер обрабатывает, пакет возвращается. Для шутеров это критично, для MMO и стратегий — терпимо. Частично решается предсказанием на клиенте, но базовый принцип остаётся.

**Нагрузка на сервер.** Вся логика крутится на сервере, поэтому он должен быть достаточно мощным. Для тысяч игроков нужно продумывать архитектуру: зонирование мира, распределение по нескольким серверам.

**Требования к сети.** Нужно стабильное соединение. При потере пакетов или высоком пинге игра будет ощущаться плохо.

---

## Применение к космическому симулятору

### Что живёт только на сервере

**Корабль как единая сущность.** Сервер хранит полное состояние корабля: положение каждого отсека, состояние каждой системы, содержимое каждого контейнера. Когда механик откручивает болт на реакторе — это происходит на сервере. Клиент механика лишь отправляет команду «взаимодействие с объектом X» и получает обратно обновлённое состояние.

**Симуляция атмосферы.** Газовый состав каждого отсека, давление, температура, распространение токсинов — всё считается на сервере. Клиент получает только итоговые значения для отображения на приборах и визуальных эффектов. Пробоина в корпусе вызывает пересчёт давления в смежных отсеках — клиенты видят результат, но не участвуют в вычислениях.

**Медицинская система.** Состояние тела каждого персонажа — органы, кровотечения, инфекции, уровень анестезии — существует только на сервере. Когда хирург делает надрез, клиент отправляет команду «инструмент Y применён к зоне Z». Сервер проверяет стерильность инструмента, глубину надреза, наличие анестезии и возвращает результат: успех, осложнение или критическая ошибка.

**Инвентарь и ресурсы.** Каждый предмет на корабле имеет точную позицию и владельца на сервере. Невозможно «дублировать» ресурсы — сервер знает, сколько кислородных баллонов осталось, и не позволит взять больше, чем есть.

**Существа и угрозы.** Поведение монстров, их позиции, состояние здоровья — всё на сервере. Клиент получает только те данные о существах, которые персонаж игрока способен воспринять. Если ползун за стеной — клиент о нём не знает, пока персонаж не увидит или не услышит его.

### Что делает клиент

**Рендеринг 3D-сцены.** Клиент получает от сервера список видимых объектов с их позициями, состояниями, анимациями. На основе этих данных строит кадр в PSX-эстетике: низкополигональные модели, аффинное текстурирование, ограниченная дальность прорисовки. Вся логика «что рисовать» определяется сервером, клиент лишь исполняет.

**Пространственный звук.** Сервер сообщает клиенту о звуковых событиях: «в точке X раздался звук Y с громкостью Z». Клиент воспроизводит звук с учётом позиции слушателя, преград, акустики помещения. Характерный гул отсеков, шипение вентиляции, скрип обшивки — всё это клиентская обработка серверных событий.

**Обработка ввода.** Клиент фиксирует нажатия клавиш, движения мыши, голосовую связь. Преобразует их в абстрактные команды — «движение вперёд», «взаимодействие», «голосовые данные» — и отправляет на сервер. Клиент не знает, к чему приведёт нажатие E — это решает сервер.

**Отображение интерфейса.** Сервер присылает данные для UI: показания приборов, содержимое инвентаря, состояние здоровья, маркеры целей. Клиент отрисовывает эту информацию в читаемом виде, но не генерирует её сам.

**Интерполяция движения.** Между серверными снимками клиент плавно перемещает объекты, чтобы движение не выглядело рывками. Это чисто визуальный трюк — авторитетная позиция всегда на сервере.

---

## Специфика для ролевой системы

### Асимметрия информации через сеть

**Разные данные для разных ролей.** Сервер отправляет каждому клиенту только ту информацию, которая доступна его роли. Механик получает детальные данные о состоянии систем, но не видит медицинских показателей экипажа. Врач видит здоровье пациента, но не знает точного запаса топлива. Это реализует принцип «асимметрии знаний» на сетевом уровне.

**Скрытые параметры.** Некоторые данные сервер не отправляет никому из игроков. Реальный запас кислорода может отличаться от показаний приборов. Истинная природа аномалии скрыта до момента исследования. Это создаёт пространство для неожиданностей и ошибок.

**Консоль капитана.** Капитан получает агрегированную информацию — общий статус систем, примерное местоположение экипажа, сводку событий. Но детали он узнаёт только от специалистов. Сетевая архитектура поддерживает эту иерархию: сервер формирует разные «представления» мира для разных ролей.

### Специализированные интерфейсы

**Медицинский терминал.** Когда хирург открывает пациента, клиент получает от сервера структурированные данные о состоянии тела: список органов с повреждениями, активные кровотечения, уровень анестезии. Клиент отображает это как схему тела с маркерами проблем. Каждое действие хирурга — выбор инструмента, область применения — отправляется на сервер как команда.

**Инженерная консоль.** Механик видит схему корабля с индикаторами состояния систем. Сервер отправляет данные о неисправностях, уровне износа, распределении энергии. Когда механик перенаправляет питание, команда уходит на сервер, тот пересчитывает энергобаланс и рассылает обновления всем затронутым системам.

**Кулинарный интерфейс.** Повар получает от сервера список доступных ингредиентов с их свойствами: питательность, срок годности, совместимость. Рецепты — это серверная логика: клиент отправляет «смешать ингредиенты A, B, C», сервер проверяет рецепт и возвращает результат — готовое блюдо с эффектами или испорченную массу.

---

## Голосовая связь

### Серверная маршрутизация

**Голос как данные.** Голосовые пакеты от игроков поступают на сервер, который решает, кто их услышит. Это не peer-to-peer — сервер контролирует распространение звука.

**Пространственная модель.** Сервер знает позицию каждого игрока и рассчитывает слышимость. Голос в соседнем отсеке — громкий и чистый. Голос через две переборки — приглушённый. Голос с другого конца корабля — не слышен без рации.

**Рация с ограничениями.** Радиосвязь проходит через сервер с модификацией: добавляются шумы, искажения, задержка в зависимости от расстояния, преград, солнечной активности. Сервер может «глушить» связь в определённых зонах или при определённых событиях.

**Имитация голосов.** Если существо способно имитировать голоса экипажа, сервер может подменить источник звука. Игрок слышит голос товарища из-за угла — но товарищ на другом конце корабля. Клиент не знает об обмане, пока не станет слишком поздно.

---

## ГеймМастер в сетевой модели

### Привилегированный клиент

**Расширенные данные.** ГеймМастер получает от сервера полную картину мира: позиции всех существ, скрытые параметры, реальное состояние систем. Его клиент отображает то, что недоступно обычным игрокам.

**Командный интерфейс.** ГМ отправляет на сервер особые команды: спавн сущностей, изменение параметров, активация событий. Сервер валидирует эти команды (ГМ не может нарушить физику мира) и исполняет их.

**Прямое управление существами.** Когда ГМ берёт контроль над монстром, его ввод транслируется в команды движения и атаки этого существа. Сервер обрабатывает их как обычный AI, но источник — человек. Для игроков разницы нет.

**Манипуляция информацией.** ГМ может «сливать» информацию экипажу через игровые каналы: генерировать записи в логах, создавать радиоперехваты, подбрасывать документы. Всё это серверные данные, которые попадают к игрокам естественным путём.

---

## Процедурная генерация и сеть

### Генерация на сервере

**Мир создаётся один раз.** При старте сессии сервер генерирует окружение: карту региона, состав аномалий, расположение ресурсов, популяцию существ. Seed генерации хранится на сервере — клиенты ничего не генерируют сами.

**Мутации существ.** Когда сервер спавнит существо, он определяет его модификаторы: устойчивость к огню, способность разделяться, имитация голосов. Клиенты получают только визуальное описание — пока не столкнутся с особенностью на практике.

**Динамические события.** Сервер выбирает и активирует события: поломки, сигналы бедствия, появление торговцев. Параметры событий определяются сервером на основе состояния экипажа, времени игры, предыдущих событий.

### Редкие явления

**Серверный контроль вероятностей.** События с вероятностью менее 1% отслеживаются сервером глобально. Он знает, сколько раз конкретное явление уже произошло в этой сессии, и может корректировать шансы.

**Синхронизация уникальных событий.** Когда происходит редкое событие, сервер рассылает всем клиентам необходимые данные для его отображения. Даже если клиент никогда не сталкивался с таким явлением, он получит достаточно информации для рендеринга.

---

## Технические решения для космического сеттинга

### Отсечная структура корабля

**Иерархическая синхронизация.** Корабль поделён на отсеки, каждый отсек — отдельная зона для сетевой оптимизации. Игрок в медотсеке получает детальные обновления о медотсеке, но грубые данные о далёких частях корабля. Это снижает трафик без потери важной информации.

**Декомпрессия как сетевое событие.** Когда отсек разгерметизирован, сервер отправляет всем клиентам событие с параметрами: какой отсек, скорость потери давления, направление утечки. Клиенты используют эти данные для визуализации: затягивание предметов к пробоине, искажение звука, эффекты на персонажах.

**Изоляция отсеков.** Если переборка закрыта, сервер может прекратить отправку детальных данных об отсечённой зоне. Игрок знает только, что дверь закрыта — что происходит за ней, неизвестно. Это и оптимизация, и элемент геймплея.

### Работа в открытом космосе

**Позиционирование в пустоте.** Сервер отслеживает позицию каждого игрока в скафандре относительно корабля и других объектов. Точность критична — ошибка в метр может означать промах мимо шлюза.

**Страховочный трос.** Связь между игроком и точкой крепления троса — серверная механика. Если трос порвётся или отцепится, сервер рассчитывает траекторию дрейфа. Клиент игрока получает только свою позицию и направление движения — без ориентиров в пустоте.

**Ограниченные ресурсы скафандра.** Кислород, топливо маневровых двигателей, заряд батареи — всё на сервере. Клиент показывает приборы, но реальные значения известны только серверу. Прибор может врать — и игрок узнает об этом, когда кислород кончится раньше, чем ожидалось.

### Шаттл и стыковка

**Пилотирование через сервер.** Команды пилота — курс, тяга, маневры — уходят на сервер. Сервер рассчитывает физику движения и возвращает позицию шаттла. Для остальных пассажиров шаттл движется так же плавно, как для пилота, благодаря интерполяции.

**Синхронизация стыковки.** Стыковка — критический момент, требующий точной синхронизации. Сервер отслеживает позиции обоих объектов и определяет успешность манёвра. Успех или неудача (столкновение, промах) определяются сервером и сообщаются всем участникам одновременно.

---

## Обработка нештатных ситуаций

### Потеря соединения

**Персонаж остаётся в мире.** Если клиент теряет связь с сервером, его персонаж не исчезает мгновенно. Сервер переводит его в состояние «автопилота» — персонаж остаётся на месте или выполняет простые действия. Экипаж видит, что товарищ «завис».

**Тайм-аут и безопасность.** После определённого времени без связи сервер перемещает персонажа в безопасную зону или переводит в режим «сна». Это защищает игрока от гибели из-за технических проблем.

**Переподключение.** При восстановлении связи клиент получает актуальный снимок мира и продолжает с текущего состояния. Пропущенные события можно компенсировать краткой сводкой от сервера.

### Десинхронизация

**Сервер всегда прав.** Если клиент показывает одно, а сервер присылает другое — клиент корректируется. Резкая телепортация персонажа означает, что предсказание клиента было неверным.

**Валидация действий.** Сервер проверяет каждую команду от клиента. Попытка взаимодействовать с предметом на другом конце корабля будет отклонена. Попытка использовать предмет, которого нет в инвентаре — тоже.

**Защита от эксплойтов.** Поскольку клиент не имеет авторитета над игровым состоянием, модифицированный клиент не даёт преимущества. Максимум, что может сделать читер — испортить своё собственное отображение.

---

## Масштабирование

### Один сервер на сессию

Для кооперативной игры с экипажем в 4-12 человек достаточно одного сервера на сессию. Нагрузка распределена равномерно: симуляция корабля, существ, атмосферы, физики.

### Выделенный и интегрированный сервер

**Выделенный сервер.** Отдельный процесс или машина. Оптимально для стабильности и производительности. Один игрок может хостить сервер и подключаться к нему как клиент.

**Интегрированный сервер.** Сервер работает внутри клиента хоста. Проще для запуска, но хост имеет преимущество в задержке. Для кооперативной игры без соревновательного элемента — приемлемо.

### Сохранение состояния

**Серверные сохранения.** Вся информация о мире хранится на сервере. При сохранении создаётся снимок: позиции, состояния, инвентари, прогресс исследований. Клиенты не хранят ничего критичного — потеря клиентского кэша не влияет на прогресс.

**Периодические автосохранения.** Сервер регулярно сохраняет состояние, чтобы минимизировать потери при сбое. Частота зависит от интенсивности событий — во время кризиса сохранения чаще.
